<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Flip Chat</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { 500: '#7c3aed', 600: '#6d28d9' },
                        secondary: { 500: '#ec4899', 600: '#db2777' }
                    },
                    borderRadius: { 'xl': '1rem', '2xl': '2rem' }
                }
            }
        }
    </script>

    <style>
        /* Точное копирование ваших стилей из файла */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden; /* Фикс для мобильных */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .dark .glass-effect {
            background: rgba(17, 24, 39, 0.9);
        }

        /* Ваши стили активных кнопок */
        .gender-option.active, .comp-gender-option.active, .age-group.active, .comp-age-group.active {
            border-color: #7c3aed;
            background-color: rgba(124, 58, 237, 0.05);
            transform: scale(0.98);
        }

        .dark .gender-option.active {
            background-color: rgba(124, 58, 237, 0.15);
        }

        /* Кастомный скролл как в оригинале */
        #messagesContainer::-webkit-scrollbar { width: 4px; }
        #messagesContainer::-webkit-scrollbar-thumb { background: rgba(124, 58, 237, 0.2); border-radius: 10px; }
        
        .chat-bubble-own {
            background: linear-gradient(135deg, #7c3aed 0%, #ec4899 100%);
            border-bottom-right-radius: 4px;
        }
        
        .chat-bubble-other {
            border-bottom-left-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-950 text-gray-900 dark:text-gray-100">

    <div id="mainContainer" class="flex-1 flex flex-col max-w-xl mx-auto w-full h-full relative">
        
        <div id="setupForm" class="flex-1 flex flex-col p-6 overflow-y-auto space-y-8 pb-24">
            <div class="text-center space-y-2 py-6">
                <h1 class="text-4xl font-black bg-gradient-to-r from-primary-500 to-secondary-500 bg-clip-text text-transparent">Flip Chat</h1>
                <p class="text-gray-400 font-medium">Найди свою половинку ✨</p>
            </div>

            <div class="space-y-4">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest px-1">Ваш пол</h3>
                <div class="grid grid-cols-2 gap-4">
                    <button class="gender-option p-6 rounded-2xl border-2 border-gray-100 dark:border-gray-800 flex flex-col items-center gap-3 transition-all" data-gender="male">
                        <div class="w-12 h-12 bg-blue-50 dark:bg-blue-900/20 rounded-full flex items-center justify-center">
                            <i data-feather="user" class="text-blue-500"></i>
                        </div>
                        <span class="font-bold">Парень</span>
                    </button>
                    <button class="gender-option p-6 rounded-2xl border-2 border-gray-100 dark:border-gray-800 flex flex-col items-center gap-3 transition-all" data-gender="female">
                        <div class="w-12 h-12 bg-pink-50 dark:bg-pink-900/20 rounded-full flex items-center justify-center">
                            <i data-feather="user" class="text-pink-500"></i>
                        </div>
                        <span class="font-bold">Девушка</span>
                    </button>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest px-1">Ваш возраст</h3>
                <div class="flex flex-wrap gap-2">
                    <button class="age-group px-6 py-3 rounded-xl border-2 border-gray-100 dark:border-gray-800 font-bold transition-all" data-age="under14">До 14</button>
                    <button class="age-group px-6 py-3 rounded-xl border-2 border-gray-100 dark:border-gray-800 font-bold transition-all" data-age="15-17">15-17</button>
                    <button class="age-group px-6 py-3 rounded-xl border-2 border-gray-100 dark:border-gray-800 font-bold transition-all" data-age="18plus">18+</button>
                </div>
            </div>

            <div class="p-6 bg-white dark:bg-gray-900 rounded-3xl shadow-sm space-y-6">
                <h3 class="text-center font-bold text-gray-500 uppercase text-xs tracking-tighter">Кого найти?</h3>
                <div class="grid grid-cols-3 gap-2">
                    <button class="comp-gender-option p-3 rounded-xl border-2 border-gray-50 dark:border-gray-800 flex flex-col items-center" data-gender="male">
                        <i data-feather="user" class="w-5 h-5 text-blue-500 mb-1"></i>
                        <span class="text-[10px] font-bold">Парня</span>
                    </button>
                    <button class="comp-gender-option p-3 rounded-xl border-2 border-gray-50 dark:border-gray-800 flex flex-col items-center" data-gender="female">
                        <i data-feather="user" class="w-5 h-5 text-pink-500 mb-1"></i>
                        <span class="text-[10px] font-bold">Девушку</span>
                    </button>
                    <button class="comp-gender-option p-3 rounded-xl border-2 border-gray-50 dark:border-gray-800 flex flex-col items-center" data-gender="any">
                        <i data-feather="users" class="w-5 h-5 text-purple-500 mb-1"></i>
                        <span class="text-[10px] font-bold">Любого</span>
                    </button>
                </div>
            </div>

            <button id="startChatBtn" class="w-full py-5 rounded-2xl bg-gradient-to-r from-primary-500 to-secondary-500 text-white font-black text-lg shadow-xl shadow-primary-500/20 disabled:opacity-30 transform active:scale-95 transition-all">
                НАЧАТЬ ПОИСК
            </button>
        </div>

        <div id="waitingScreen" class="hidden absolute inset-0 z-50 bg-white dark:bg-gray-950 flex flex-col items-center justify-center p-8">
            <div class="relative w-24 h-24 mb-6">
                <div class="absolute inset-0 border-4 border-primary-500 rounded-full animate-ping opacity-25"></div>
                <div class="absolute inset-0 border-4 border-primary-600 rounded-full animate-spin border-t-transparent"></div>
            </div>
            <h2 class="text-xl font-bold">Ищем собеседника...</h2>
            <button onclick="location.reload()" class="mt-8 text-gray-400 font-bold">ОТМЕНА</button>
        </div>

        <div id="chatInterface" class="hidden flex-1 flex flex-col h-full overflow-hidden bg-white dark:bg-gray-950">
            <div class="p-4 border-b dark:border-gray-800 flex justify-between items-center glass-effect sticky top-0 z-10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-r from-primary-500 to-secondary-500"></div>
                    <div>
                        <p class="font-bold text-sm">Анонимный чат</p>
                        <p id="chatStatus" class="text-[10px] text-green-500 font-bold">В сети</p>
                    </div>
                </div>
                <button onclick="location.reload()" class="p-2 bg-gray-100 dark:bg-gray-800 rounded-full text-red-500"><i data-feather="x"></i></button>
            </div>

            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
                </div>

            <div class="p-4 border-t dark:border-gray-800 bg-white dark:bg-gray-900 shrink-0">
                <div class="flex items-center gap-2">
                    <input type="text" id="messageInput" placeholder="Напиши что-нибудь..." class="flex-1 p-4 bg-gray-100 dark:bg-gray-800 rounded-2xl outline-none focus:ring-2 focus:ring-primary-500">
                    <button id="sendBtn" class="w-14 h-14 bg-primary-500 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-primary-500/30">
                        <i data-feather="send"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        feather.replace();
        let connection = null;
        let userData = { gender: null, age: null, compGender: null, compAge: 'any' };

        // Логика выбора опций (идентично вашему файлу)
        function initToggles() {
            const setupSelect = (selector, key) => {
                document.querySelectorAll(selector).forEach(btn => {
                    btn.onclick = () => {
                        document.querySelectorAll(selector).forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        userData[key] = btn.dataset.gender || btn.dataset.age;
                        if (window.Telegram?.WebApp) Telegram.WebApp.HapticFeedback.impactOccurred('medium');
                    };
                });
            };

            setupSelect('.gender-option', 'gender');
            setupSelect('.age-group', 'age');
            setupSelect('.comp-gender-option', 'compGender');
        }

        async function startSignalR() {
            // Динамический URL (Railway-совместимый)
            const hubUrl = `${window.location.protocol}//${window.location.host}/chat`;
            
            connection = new signalR.HubConnectionBuilder()
                .withUrl(hubUrl)
                .withAutomaticReconnect()
                .build();

            connection.on("ReceiveMessage", (msg) => appendMessage(msg.text, false));
            connection.on("MatchFound", () => {
                document.getElementById('waitingScreen').classList.add('hidden');
                document.getElementById('chatInterface').classList.remove('hidden');
            });

            try { await connection.start(); } catch (err) { console.error(err); }
        }

        function appendMessage(text, isOwn) {
            const container = document.getElementById('messagesContainer');
            const div = document.createElement('div');
            div.className = `flex ${isOwn ? 'justify-end' : 'justify-start'}`;
            div.innerHTML = `
                <div class="max-w-[85%] p-4 rounded-2xl shadow-sm text-sm ${
                    isOwn ? 'chat-bubble-own text-white' : 'chat-bubble-other bg-gray-100 dark:bg-gray-800 dark:text-gray-100'
                }">
                    ${text}
                </div>
            `;
            container.appendChild(div);
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
        }

        document.getElementById('startChatBtn').onclick = () => {
            if(!userData.gender || !userData.age || !userData.compGender) return alert("Выбери все параметры!");
            document.getElementById('setupForm').classList.add('hidden');
            document.getElementById('waitingScreen').classList.remove('hidden');
            
            connection.invoke("JoinChat", {
                Gender: userData.gender,
                Age: userData.age,
                CompanionGender: userData.compGender,
                CompanionAge: userData.compAge
            });
        };

        document.getElementById('sendBtn').onclick = () => {
            const input = document.getElementById('messageInput');
            if(!input.value.trim()) return;
            connection.invoke("SendMessage", input.value);
            appendMessage(input.value, true);
            input.value = "";
        };

        initToggles();
        startSignalR();
        if (window.Telegram?.WebApp) Telegram.WebApp.expand();
    </script>
</body>
</html>
