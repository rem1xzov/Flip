<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Flip Chat</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { 500: '#7c3aed', 600: '#6d28d9' },
                        secondary: { 500: '#ec4899', 600: '#db2777' }
                    },
                    borderRadius: { 'xl': '1rem', '2xl': '2rem' }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f9fafb; /* –°–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        }

        .dark body {
            background-color: #030712; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
        }

        /* –£–±–∏—Ä–∞–µ–º —Å–∏–Ω–µ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏ —Ç–∞–ø–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        button {
            outline: none !important;
            -webkit-tap-highlight-color: transparent;
        }

        /* –°—Ç–∏–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ */
        .gender-option.active, .comp-gender-option.active, .age-group.active, .comp-age-group.active {
            border-color: #7c3aed;
            background-color: rgba(124, 58, 237, 0.05);
            transform: scale(0.98);
            box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.1);
        }

        .dark .gender-option.active {
            background-color: rgba(124, 58, 237, 0.15);
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .chat-bubble-own {
            background: linear-gradient(135deg, #7c3aed 0%, #ec4899 100%);
            border-bottom-right-radius: 4px;
            color: white;
        }
        
        .chat-bubble-other {
            background-color: #f3f4f6;
            color: #1f2937;
            border-bottom-left-radius: 4px;
        }

        .dark .chat-bubble-other {
            background-color: #1f2937;
            color: #f3f4f6;
        }

        /* –°–∫—Ä–æ–ª–ª */
        #messagesContainer::-webkit-scrollbar { width: 4px; }
        #messagesContainer::-webkit-scrollbar-thumb { background: rgba(124, 58, 237, 0.2); border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-950 text-gray-900 dark:text-gray-100 transition-colors duration-200">

    <div id="app" class="flex-1 flex flex-col h-full w-full max-w-lg mx-auto relative overflow-hidden">
        
        <div id="setupForm" class="flex-1 flex flex-col p-6 overflow-y-auto pb-24 z-20 bg-gray-50 dark:bg-gray-950 absolute inset-0">
            <div class="text-center space-y-2 py-6 shrink-0">
                <h1 class="text-4xl font-black bg-gradient-to-r from-primary-500 to-secondary-500 bg-clip-text text-transparent">Flip Chat</h1>
                <p class="text-gray-400 font-medium text-sm">–ê–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç v2.0</p>
            </div>

            <div class="space-y-6 flex-1">
                <div class="space-y-3">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest px-1">–Ø</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button class="gender-option p-5 rounded-2xl border-2 border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 flex flex-col items-center gap-2 transition-all" data-gender="male">
                            <div class="w-10 h-10 bg-blue-50 dark:bg-blue-900/20 rounded-full flex items-center justify-center">
                                <i data-feather="user" class="text-blue-500 w-5 h-5"></i>
                            </div>
                            <span class="font-bold text-sm">–ü–∞—Ä–µ–Ω—å</span>
                        </button>
                        <button class="gender-option p-5 rounded-2xl border-2 border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 flex flex-col items-center gap-2 transition-all" data-gender="female">
                            <div class="w-10 h-10 bg-pink-50 dark:bg-pink-900/20 rounded-full flex items-center justify-center">
                                <i data-feather="user" class="text-pink-500 w-5 h-5"></i>
                            </div>
                            <span class="font-bold text-sm">–î–µ–≤—É—à–∫–∞</span>
                        </button>
                    </div>
                </div>

                <div class="space-y-3">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest px-1">–ú–æ–π –≤–æ–∑—Ä–∞—Å—Ç</h3>
                    <div class="flex gap-2">
                        <button class="age-group flex-1 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 font-bold text-sm transition-all" data-age="under14">–î–æ 14</button>
                        <button class="age-group flex-1 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 font-bold text-sm transition-all" data-age="15-17">15-17</button>
                        <button class="age-group flex-1 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 font-bold text-sm transition-all" data-age="18plus">18+</button>
                    </div>
                </div>

                <div class="p-5 bg-white dark:bg-gray-900 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-800 space-y-4">
                    <h3 class="text-center font-bold text-gray-400 uppercase text-xs tracking-widest">–ö–æ–≥–æ –∏—â–µ–º?</h3>
                    <div class="grid grid-cols-3 gap-2">
                        <button class="comp-gender-option p-3 rounded-xl border-2 border-gray-50 dark:border-gray-800 flex flex-col items-center transition-all hover:bg-gray-50 dark:hover:bg-gray-800" data-gender="male">
                            <span class="text-[10px] font-bold mt-1">–ü–∞—Ä–Ω—è</span>
                        </button>
                        <button class="comp-gender-option p-3 rounded-xl border-2 border-gray-50 dark:border-gray-800 flex flex-col items-center transition-all hover:bg-gray-50 dark:hover:bg-gray-800" data-gender="female">
                            <span class="text-[10px] font-bold mt-1">–î–µ–≤—É—à–∫—É</span>
                        </button>
                        <button class="comp-gender-option p-3 rounded-xl border-2 border-gray-50 dark:border-gray-800 flex flex-col items-center transition-all hover:bg-gray-50 dark:hover:bg-gray-800" data-gender="any">
                            <span class="text-[10px] font-bold mt-1">–õ—é–±–æ–≥–æ</span>
                        </button>
                    </div>
                </div>
            </div>

            <button id="startChatBtn" class="w-full py-4 mt-6 rounded-2xl bg-gradient-to-r from-primary-500 to-secondary-500 text-white font-black text-lg shadow-xl shadow-primary-500/20 disabled:opacity-50 disabled:cursor-not-allowed transform active:scale-95 transition-all shrink-0">
                –ü–û–ò–°–ö
            </button>
        </div>

        <div id="waitingScreen" class="hidden absolute inset-0 z-30 bg-white dark:bg-gray-950 flex flex-col items-center justify-center p-8">
            <div class="relative w-20 h-20 mb-6">
                <div class="absolute inset-0 border-4 border-primary-500 rounded-full animate-ping opacity-25"></div>
                <div class="absolute inset-0 border-4 border-primary-600 rounded-full animate-spin border-t-transparent"></div>
            </div>
            <h2 class="text-xl font-bold">–ò—â–µ–º –ø–∞—Ä—É...</h2>
            <button onclick="resetApp()" class="mt-8 text-red-500 font-bold text-sm px-6 py-2 rounded-full border border-red-500/20">–û–¢–ú–ï–ù–ê</button>
        </div>

        <div id="chatInterface" class="hidden absolute inset-0 z-40 flex flex-col bg-white dark:bg-gray-950 h-full w-full">
            <div class="px-4 py-3 border-b dark:border-gray-800 flex justify-between items-center bg-white/90 dark:bg-gray-900/90 backdrop-blur-md sticky top-0 z-10 shadow-sm">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary-500 to-secondary-500 flex items-center justify-center text-white shadow-md">
                        <i data-feather="user" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <p class="font-bold text-sm leading-tight">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</p>
                        <div class="flex items-center gap-1.5">
                            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                            <span id="chatStatus" class="text-[10px] text-gray-500 font-medium">–û–Ω–ª–∞–π–Ω</span>
                        </div>
                    </div>
                </div>
                <button onclick="resetApp()" class="p-2 bg-gray-100 dark:bg-gray-800 rounded-full text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50 dark:bg-gray-950 w-full">
                </div>

            <div class="p-3 border-t dark:border-gray-800 bg-white dark:bg-gray-900 shrink-0 w-full pb-safe">
                <div class="flex items-center gap-2 max-w-full">
                    <input type="text" id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 py-3 px-4 bg-gray-100 dark:bg-gray-800 rounded-2xl outline-none focus:ring-2 focus:ring-primary-500 text-sm dark:text-white transition-all">
                    <button id="sendBtn" class="w-12 h-12 bg-primary-500 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-primary-500/30 active:scale-90 transition-transform">
                        <i data-feather="send" class="w-5 h-5 ml-0.5"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∫–æ–Ω–æ–∫
        feather.replace();
        
        let connection = null;
        let userData = { gender: null, age: null, compGender: null, compAge: 'any' };

        // 1. –§–£–ù–ö–¶–ò–Ø –ü–û–õ–ù–û–ì–û –°–ë–†–û–°–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (–ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï)
        function resetApp() {
            // –°–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç –∏ –æ–∂–∏–¥–∞–Ω–∏–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('setupForm').classList.remove('hidden');
            document.getElementById('waitingScreen').classList.add('hidden');
            document.getElementById('chatInterface').classList.add('hidden');
            
            // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            document.getElementById('messagesContainer').innerHTML = '';
            
            // –†–∞–∑—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (connection) {
                connection.stop().catch(err => console.error(err));
            }
        }

        // –í—ã–∑—ã–≤–∞–µ–º —Å–±—Ä–æ—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å "–∑–∞–≤–∏—Å—à–∏–µ" —ç–∫—Ä–∞–Ω—ã
        document.addEventListener('DOMContentLoaded', () => {
            resetApp(); 
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            initToggles();
            
            // Telegram WebApp
            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.ready();
            }
        });

        function initToggles() {
            const setupSelect = (selector, key) => {
                document.querySelectorAll(selector).forEach(btn => {
                    btn.onclick = () => {
                        // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã
                        document.querySelectorAll(selector).forEach(b => b.classList.remove('active'));
                        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–π
                        btn.classList.add('active');
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä
                        userData[key] = btn.dataset.gender || btn.dataset.age;
                        
                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º—ã
                        validateForm();

                        // –í–∏–±—Ä–∞—Ü–∏—è
                        if (window.Telegram?.WebApp) Telegram.WebApp.HapticFeedback.impactOccurred('light');
                    };
                });
            };

            setupSelect('.gender-option', 'gender');
            setupSelect('.age-group', 'age');
            setupSelect('.comp-gender-option', 'compGender');
        }

        function validateForm() {
            const btn = document.getElementById('startChatBtn');
            if (userData.gender && userData.age && userData.compGender) {
                btn.disabled = false;
                btn.style.opacity = "1";
            } else {
                btn.disabled = true;
                btn.style.opacity = "0.5";
            }
        }

        // –õ–æ–≥–∏–∫–∞ SignalR
        async function startSearch() {
            if(!userData.gender || !userData.age || !userData.compGender) return;

            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —ç–∫—Ä–∞–Ω—ã
            document.getElementById('setupForm').classList.add('hidden');
            document.getElementById('waitingScreen').classList.remove('hidden');

            const hubUrl = `${window.location.protocol}//${window.location.host}/chat`;
            
            connection = new signalR.HubConnectionBuilder()
                .withUrl(hubUrl)
                .withAutomaticReconnect()
                .build();

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            connection.on("ReceiveMessage", (msg) => appendMessage(msg.text, false));
            
            connection.on("MatchFound", () => {
                document.getElementById('waitingScreen').classList.add('hidden');
                document.getElementById('chatInterface').classList.remove('hidden');
                appendSystemMessage("–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω! –°–∫–∞–∂–∏—Ç–µ –ø—Ä–∏–≤–µ—Ç üëã");
                if (window.Telegram?.WebApp) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            });

            connection.on("UserLeft", () => {
                appendSystemMessage("–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è.");
                setTimeout(resetApp, 3000); // –ê–≤—Ç–æ-–≤—ã—Ö–æ–¥ —á–µ—Ä–µ–∑ 3 —Å–µ–∫
            });

            try {
                await connection.start();
                console.log("Connected");
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞
                await connection.invoke("JoinChat", {
                    Gender: userData.gender,
                    Age: userData.age,
                    CompanionGender: userData.compGender,
                    CompanionAge: userData.compAge
                });

            } catch (err) {
                console.error(err);
                alert("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É!");
                resetApp();
            }
        }

        document.getElementById('startChatBtn').onclick = startSearch;

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if(!text || !connection) return;

            connection.invoke("SendMessage", text)
                .catch(err => console.error(err));
            
            appendMessage(text, true);
            input.value = "";
        }

        document.getElementById('sendBtn').onclick = sendMessage;
        document.getElementById('messageInput').onkeypress = (e) => {
            if(e.key === 'Enter') sendMessage();
        };

        // –§—É–Ω–∫—Ü–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
        function appendMessage(text, isOwn) {
            const container = document.getElementById('messagesContainer');
            const div = document.createElement('div');
            div.className = `flex ${isOwn ? 'justify-end' : 'justify-start'} animate-fade-in`;
            div.innerHTML = `
                <div class="max-w-[85%] px-4 py-3 text-sm shadow-sm ${
                    isOwn ? 'chat-bubble-own' : 'chat-bubble-other'
                }">
                    ${escapeHtml(text)}
                </div>
            `;
            container.appendChild(div);
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
            requestAnimationFrame(() => {
                container.scrollTop = container.scrollHeight;
            });
        }

        function appendSystemMessage(text) {
            const container = document.getElementById('messagesContainer');
            const div = document.createElement('div');
            div.className = "flex justify-center my-2";
            div.innerHTML = `<span class="bg-gray-200 dark:bg-gray-800 text-gray-500 text-[10px] px-3 py-1 rounded-full font-bold uppercase tracking-widest">${text}</span>`;
            container.appendChild(div);
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–∏—Å–∫–∞
        validateForm();
    </script>
</body>
</html>
