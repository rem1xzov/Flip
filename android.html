<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flip Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <!-- SignalR JavaScript Client -->
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            500: '#7c3aed',
                            600: '#6d28d9',
                        },
                        secondary: {
                            500: '#ec4899',
                            600: '#db2777',
                        }
                    },
                    borderRadius: {
                        'xl': '1rem',
                        '2xl': '2rem',
                    }
                }
            }
        }
    </script>
    <style>
        /* ... ВСЕ СТИЛИ ОСТАЮТСЯ БЕЗ ИЗМЕНЕНИЙ ... */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        /* ... ВСЕ ОСТАЛЬНЫЕ СТИЛИ ОСТАЮТСЯ ТАКИМИ ЖЕ ... */
    </style>
</head>
<body class="h-full flex items-center justify-center p-4">
<!-- HTML РАЗМЕТКА ОСТАЕТСЯ БЕЗ ИЗМЕНЕНИЙ -->
<div class="max-w-4xl w-full glass-effect rounded-2xl shadow-2xl overflow-hidden border border-white/30">
    <div class="bg-gradient-to-r from-primary-500 to-secondary-500 p-8 text-white text-center">
        <h1 class="text-4xl font-bold">Flip Chat✨</h1>
        <p class="text-lg mt-3 opacity-90">Наслаждайтесь общением!</p>
        <div id="connectionStatus" class="mt-2 text-sm opacity-75">
            <span id="statusText">Подключение...</span>
        </div>
    </div>

    <!-- Setup Form -->
    <div id="setupForm" class="p-10">
        <!-- ... ВСЯ РАЗМЕТКА ФОРМЫ ОСТАЕТСЯ БЕЗ ИЗМЕНЕНИЙ ... -->
    </div>

    <!-- Chat Interface (Hidden by default) -->
    <div id="chatInterface" class="hidden">
        <!-- ... ВСЯ РАЗМЕТКА ЧАТА ОСТАЕТСЯ БЕЗ ИЗМЕНЕНИЙ ... -->
    </div>

    <!-- Waiting Screen -->
    <div id="waitingScreen" class="hidden p-10 text-center">
        <!-- ... ВСЯ РАЗМЕТКА ЭКРАНА ОЖИДАНИЯ ОСТАЕТСЯ БЕЗ ИЗМЕНЕНИЙ ... -->
    </div>
</div>

<script>
    feather.replace();

    // Переменные для хранения данных и подключения
    let userData = {
        gender: null,
        age: null,
        companionGender: null,
        companionAge: null,
        theme: 'light'
    };

    let connection = null;
    let isConnected = false;
    let isInChat = false;

    // DOM элементы
    const setupForm = document.getElementById('setupForm');
    const chatInterface = document.getElementById('chatInterface');
    const waitingScreen = document.getElementById('waitingScreen');
    const statusText = document.getElementById('statusText');
    const validationError = document.getElementById('validationError');
    const startChatBtn = document.getElementById('startChatBtn');
    const messageInput = document.getElementById('messageInput');
    const messagesContainer = document.getElementById('messagesContainer');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const companionInfoEl = document.getElementById('companionInfo');
    const charCounterEl = document.getElementById('charCounter');
    const newCompanionBtn = document.getElementById('newCompanionBtn');

    // ФИКС: Правильная функция для получения URL хаба
    function getHubUrl() {
        // 1. Если есть глобальная настройка - используем ее
        if (window.FLIPCHAT_BACKEND_URL && typeof window.FLIPCHAT_BACKEND_URL === 'string') {
            let backendUrl = window.FLIPCHAT_BACKEND_URL.trim();
            // Удаляем завершающие слэши
            backendUrl = backendUrl.replace(/\/+$/, '');
            // Добавляем путь к хабу
            return backendUrl + '/chat';
        }

        // 2. Для локального режима - используем текущий хост
        const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
        const host = window.location.host;
        
        return `${protocol}//${host}/chat`;
    }

    // ФИКС: Упрощенная функция инициализации SignalR
    function initializeSignalR() {
        try {
            const hubUrl = getHubUrl();
            console.log('Подключение к SignalR хабу:', hubUrl);
            
            // Используем WebSocket с автоматическим переключением на LongPolling при необходимости
            connection = new signalR.HubConnectionBuilder()
                .withUrl(hubUrl)
                .withAutomaticReconnect([0, 1000, 3000, 5000])
                .build();

            // Обработчики событий подключения
            connection.onclose((error) => {
                isConnected = false;
                updateConnectionStatus('Отключено', 'text-red-400');
                console.log('SignalR соединение закрыто:', error);
            });

            connection.onreconnecting((error) => {
                updateConnectionStatus('Переподключение...', 'text-yellow-400');
                console.log('SignalR переподключение:', error);
            });

            connection.onreconnected((connectionId) => {
                isConnected = true;
                updateConnectionStatus('Подключено', 'text-green-400');
                console.log('SignalR переподключился:', connectionId);
            });

            // Обработчики событий чата
            connection.on("ReceiveMessage", (message) => {
                addMessageToChat(message.text, false);
            });

            connection.on("MatchFound", (companion) => {
                console.log('Найден собеседник:', companion);
                showChatInterface();
                addSystemMessage('Собеседник найден! Начинайте общение!');
                if (companion && companion.gender && companion.age) {
                    const genderName = companion.gender === 'male' ? 'Мужчина' : companion.gender === 'female' ? 'Женщина' : 'Другое';
                    const ageName = companion.age === 'under14' ? 'До 14' : companion.age === '15-17' ? '15-17' : '18+';
                    if (companionInfoEl) companionInfoEl.textContent = `${genderName}, ${ageName}`;
                } else if (companionInfoEl) {
                    companionInfoEl.textContent = '';
                }
            });

            connection.on("UserJoined", (message) => {
                console.log('Пользователь присоединился:', message);
                updateConnectionStatus('Подключено', 'text-green-400');
            });

            connection.on("UserLeft", (message) => {
                console.log('Пользователь вышел:', message);
                addSystemMessage(message);
                isInChat = false;
                if (window._typingNode) { 
                    window._typingNode.remove(); 
                    window._typingNode = null; 
                }
                setTimeout(() => {
                    clearChat();
                    showSetupForm();
                    validateForm();
                    startChatBtn.disabled = false;
                }, 1500);
            });

            connection.on("WaitingForCompanion", () => {
                console.log('Ожидание собеседника...');
                showWaitingScreen();
            });

            connection.on('TypingStatus', (isTyping) => {
                if (!window._typingNode && isTyping) {
                    window._typingNode = document.createElement('div');
                    window._typingNode.className = 'chat-message flex justify-center';
                    const inner = document.createElement('div');
                    inner.className = 'text-xs text-gray-400 italic';
                    inner.textContent = 'Собеседник печатает...';
                    window._typingNode.appendChild(inner);
                    messagesContainer.appendChild(window._typingNode);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    return;
                }
                if (window._typingNode && !isTyping) {
                    window._typingNode.remove();
                    window._typingNode = null;
                }
            });

            // Подключение
            connection.start()
                .then(() => {
                    isConnected = true;
                    updateConnectionStatus('Подключено', 'text-green-400');
                    console.log('SignalR подключен');
                })
                .catch(err => {
                    console.error('Ошибка подключения:', err);
                    updateConnectionStatus('Ошибка подключения', 'text-red-400');
                    showError('Ошибка подключения к серверу. Проверьте, что backend запущен.');
                });

        } catch (error) {
            console.error('Ошибка инициализации SignalR:', error);
            showError('Ошибка инициализации SignalR: ' + error.message);
        }
    }

    // Вспомогательные функции (остаются без изменений)
    function persistUserData() {
        try { localStorage.setItem('flipchat:userData', JSON.stringify(userData)); } catch (_) {}
    }

    function loadUserData() {
        try {
            const raw = localStorage.getItem('flipchat:userData');
            if (!raw) return;
            const parsed = JSON.parse(raw);
            if (parsed && typeof parsed === 'object') {
                userData = { ...userData, ...parsed };
            }
        } catch (_) {}
    }

    function applyTheme(theme) {
        const root = document.documentElement;
        if (theme === 'dark') {
            root.setAttribute('data-theme', 'dark');
        } else {
            root.removeAttribute('data-theme');
        }
    }

    function clearChat() {
        if (messagesContainer) messagesContainer.innerHTML = '';
        if (companionInfoEl) companionInfoEl.textContent = '';
        if (window._typingNode) { window._typingNode.remove(); window._typingNode = null; }
        messageInput.value = '';
        sendMessageBtn.disabled = true;
    }

    function updateConnectionStatus(text, className) {
        statusText.textContent = text;
        statusText.className = className;
    }

    function showError(message) {
        validationError.textContent = message;
        validationError.classList.remove('hidden');
    }

    function showSetupForm() {
        setupForm.classList.remove('hidden');
        chatInterface.classList.add('hidden');
        waitingScreen.classList.add('hidden');
        isInChat = false;
    }

    function showWaitingScreen() {
        setupForm.classList.add('hidden');
        chatInterface.classList.add('hidden');
        waitingScreen.classList.remove('hidden');
    }

    function showChatInterface() {
        setupForm.classList.add('hidden');
        chatInterface.classList.remove('hidden');
        waitingScreen.classList.add('hidden');
        isInChat = true;
        messageInput.focus();
    }

    function addMessageToChat(text, isOwn = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message flex ${isOwn ? 'justify-end' : 'justify-start'}`;

        const messageContent = document.createElement('div');
        messageContent.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${
            isOwn
                ? 'bg-primary-500 text-white'
                : 'bg-gray-200 text-gray-800'
        }`;

        const msg = document.createElement('div');
        msg.textContent = text;
        const ts = new Date();
        const time = `${String(ts.getHours()).padStart(2,'0')}:${String(ts.getMinutes()).padStart(2,'0')}`;
        const meta = document.createElement('div');
        meta.className = `text-[10px] mt-1 ${isOwn ? 'text-white/80' : 'text-gray-500'}`;
        meta.textContent = time;

        messageContent.appendChild(msg);
        messageContent.appendChild(meta);

        messageDiv.appendChild(messageContent);
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function addSystemMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message flex justify-center';

        const messageContent = document.createElement('div');
        messageContent.className = 'px-4 py-2 rounded-2xl bg-yellow-100 text-yellow-800 text-sm';
        messageContent.textContent = text;

        messageDiv.appendChild(messageContent);
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        return messageDiv;
    }

    function validateForm() {
        const isValid = userData.gender && userData.age && userData.companionGender && userData.companionAge;
        startChatBtn.disabled = !isValid;
        if (isValid) {
            validationError.classList.add('hidden');
        }
    }

    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message || !isConnected || !isInChat) return;

        if (connection && connection.state === signalR.HubConnectionState.Connected) {
            connection.invoke("SendMessage", message)
                .then(() => {
                    addMessageToChat(message, true);
                    messageInput.value = '';
                    sendMessageBtn.disabled = true;
                    if (window._typingNode) {
                        window._typingNode.remove();
                        window._typingNode = null;
                    }
                    if (connection && connection.state === signalR.HubConnectionState.Connected) {
                        connection.invoke('Typing', false).catch(() => {});
                    }
                })
                .catch(err => {
                    console.error('Ошибка отправки сообщения:', err);
                    showError('Ошибка отправки сообщения');
                });
        }
    }

    // Обработчики событий для выбора пола, возраста и темы (остаются без изменений)
    const genderOptions = document.querySelectorAll('.gender-option');
    const compGenderOptions = document.querySelectorAll('.comp-gender-option');

    genderOptions.forEach(option => {
        option.addEventListener('click', function() {
            genderOptions.forEach(opt => {
                opt.classList.remove('selected', 'bg-primary-500', 'text-white', 'border-primary-500');
            });
            this.classList.add('selected', 'bg-primary-500', 'text-white', 'border-primary-500');
            userData.gender = this.dataset.gender;
            validateForm();
            persistUserData();
        });
    });

    compGenderOptions.forEach(option => {
        option.addEventListener('click', function() {
            compGenderOptions.forEach(opt => {
                opt.classList.remove('selected', 'bg-secondary-500', 'text-white', 'border-secondary-500');
            });
            this.classList.add('selected', 'bg-secondary-500', 'text-white', 'border-secondary-500');
            userData.companionGender = this.dataset.gender;
            validateForm();
            persistUserData();
        });
    });

    const ageGroups = document.querySelectorAll('.age-group');
    const compAgeGroups = document.querySelectorAll('.comp-age-group');

    ageGroups.forEach(group => {
        group.addEventListener('click', function() {
            ageGroups.forEach(g => {
                const chk = g.querySelector('.age-check');
                if (chk) chk.classList.remove('bg-primary-500', 'border-primary-500', 'opacity-100');
                g.classList.remove('selected', 'border-primary-500', 'bg-primary-50');
            });
            const check = this.querySelector('.age-check');
            if (check) check.classList.add('bg-primary-500', 'border-primary-500', 'opacity-100');
            this.classList.add('selected', 'border-primary-500', 'bg-primary-50');
            userData.age = this.dataset.age;
            validateForm();
            persistUserData();
        });
    });

    compAgeGroups.forEach(group => {
        group.addEventListener('click', function() {
            compAgeGroups.forEach(g => {
                const chk = g.querySelector('.age-check');
                if (chk) chk.classList.remove('bg-secondary-500', 'border-secondary-500', 'opacity-100');
                g.classList.remove('selected', 'border-secondary-500', 'bg-pink-50');
            });
            const check = this.querySelector('.age-check');
            if (check) check.classList.add('bg-secondary-500', 'border-secondary-500', 'opacity-100');
            this.classList.add('selected', 'border-secondary-500', 'bg-pink-50');
            userData.companionAge = this.dataset.age;
            validateForm();
            persistUserData();
        });
    });

    const themeSelectors = document.querySelectorAll('.theme-selector');
    themeSelectors.forEach(selector => {
        selector.addEventListener('click', function() {
            themeSelectors.forEach(s => s.classList.remove('selected'));
            this.classList.add('selected');
            userData.theme = this.dataset.theme;
            persistUserData();
            applyTheme(userData.theme);
        });
    });

    // Обработчики кнопок
    startChatBtn.addEventListener('click', function() {
        if (!isConnected) {
            showError('Нет подключения к серверу');
            return;
        }

        if (connection && connection.state === signalR.HubConnectionState.Connected) {
            startChatBtn.disabled = true;
            connection.invoke("JoinChat", userData)
                .then(() => {
                    console.log('JoinChat успешно');
                })
                .catch(err => {
                    console.error('JoinChat ошибка:', err);
                    showError('Ошибка подключения к чату');
                    startChatBtn.disabled = false;
                });
        }
    });

    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    messageInput.addEventListener('input', function() {
        const txt = messageInput.value.trim();
        sendMessageBtn.disabled = !txt || !isConnected || !isInChat;
        if (connection && connection.state === signalR.HubConnectionState.Connected) {
            connection.invoke('Typing', txt.length > 0).catch(() => {});
        }
        if (charCounterEl) {
            const left = 1000 - (messageInput.value.length || 0);
            charCounterEl.textContent = `Осталось символов: ${left}`;
        }
    });

    sendMessageBtn.addEventListener('click', sendMessage);

    if (newCompanionBtn) {
        newCompanionBtn.addEventListener('click', function() {
            if (connection && connection.state === signalR.HubConnectionState.Connected) {
                connection.invoke('FindNewCompanion').catch(err => console.error(err));
            }
            showWaitingScreen();
        });
    }

    document.getElementById('leaveChatBtn').addEventListener('click', function() {
        if (connection && connection.state === signalR.HubConnectionState.Connected) {
            connection.stop();
        }
        showSetupForm();
        startChatBtn.disabled = false;
    });

    document.getElementById('cancelSearchBtn').addEventListener('click', function() {
        if (connection && connection.state === signalR.HubConnectionState.Connected) {
            connection.stop();
        }
        showSetupForm();
        startChatBtn.disabled = false;
    });

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        loadUserData();

        if (userData.gender) {
            const btn = document.querySelector(`.gender-option[data-gender="${userData.gender}"]`);
            if (btn) btn.click();
        }
        if (userData.companionGender) {
            const btn = document.querySelector(`.comp-gender-option[data-gender="${userData.companionGender}"]`);
            if (btn) btn.click();
        }
        if (userData.age) {
            const el = document.querySelector(`.age-group[data-age="${userData.age}"]`);
            if (el) el.click();
        }
        if (userData.companionAge) {
            const el = document.querySelector(`.comp-age-group[data-age="${userData.companionAge}"]`);
            if (el) el.click();
        }
        if (userData.theme) {
            const el = document.querySelector(`.theme-selector[data-theme="${userData.theme}"]`);
            if (el) el.click();
        }
        applyTheme(userData.theme);

        // ФИКС: Упрощенная инициализация SignalR
        initializeSignalR();
        sendMessageBtn.disabled = true;
    });
</script>
</body>
</html>
