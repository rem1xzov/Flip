<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Flip Chat</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { 500: '#7c3aed', 600: '#6d28d9' },
                        secondary: { 500: '#ec4899', 600: '#db2777' }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dark body {
            background: linear-gradient(135deg, #0f172a 0%, #111827 100%);
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .dark .glass-effect {
            background: rgba(17, 24, 39, 0.9);
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Плавный скролл для сообщений */
        #messagesContainer {
            scrollbar-width: thin;
            scrollbar-color: rgba(124, 58, 237, 0.3) transparent;
        }

        .selected {
            ring: 3px;
            ring-color: #7c3aed;
            border-color: #7c3aed !important;
        }
        
        /* Анимация появления сообщений */
        .chat-message {
            animation: fadeIn 0.2s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="p-0 sm:p-4">

<div class="w-full max-w-4xl h-screen sm:h-[90vh] glass-effect sm:rounded-2xl shadow-2xl flex flex-col overflow-hidden border border-white/20">
    
    <div class="bg-gradient-to-r from-primary-500 to-secondary-500 p-4 sm:p-6 text-white text-center shrink-0">
        <h1 class="text-2xl sm:text-3xl font-bold">Flip Chat✨</h1>
        <div id="connectionStatus" class="text-xs opacity-80 mt-1">
            <span id="statusText">Подключение...</span>
        </div>
    </div>

    <div class="flex-1 relative overflow-hidden flex flex-col">
        
        <div id="setupForm" class="absolute inset-0 z-10 p-4 sm:p-8 overflow-y-auto bg-white/50 dark:bg-gray-900/50">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <h2 class="text-xl font-semibold border-b pb-2 dark:text-white">Ваш профиль</h2>
                    <div class="grid grid-cols-3 gap-2">
                        <button class="gender-btn p-3 rounded-xl border-2 dark:text-gray-300 dark:border-gray-700 hover:border-primary-500 transition-all flex flex-col items-center" data-type="user" data-val="male">
                            <i data-feather="user"></i> <span class="text-xs mt-1">Муж.</span>
                        </button>
                        <button class="gender-btn p-3 rounded-xl border-2 dark:text-gray-300 dark:border-gray-700 hover:border-primary-500 transition-all flex flex-col items-center" data-type="user" data-val="female">
                            <i data-feather="user"></i> <span class="text-xs mt-1">Жен.</span>
                        </button>
                        <button class="gender-btn p-3 rounded-xl border-2 dark:text-gray-300 dark:border-gray-700 hover:border-primary-500 transition-all flex flex-col items-center" data-type="user" data-val="other">
                            <i data-feather="user-plus"></i> <span class="text-xs mt-1">Другой</span>
                        </button>
                    </div>
                    <select id="userAge" class="w-full p-3 rounded-xl border-2 dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none focus:border-primary-500">
                        <option value="" disabled selected>Ваш возраст</option>
                        <option value="under14">До 14</option>
                        <option value="15-17">15 - 17</option>
                        <option value="18plus">18+</option>
                    </select>
                </div>

                <div class="space-y-4">
                    <h2 class="text-xl font-semibold border-b pb-2 dark:text-white">Искать кого?</h2>
                    <div class="grid grid-cols-3 gap-2">
                        <button class="gender-btn p-3 rounded-xl border-2 dark:text-gray-300 dark:border-gray-700 hover:border-secondary-500 transition-all flex flex-col items-center" data-type="comp" data-val="male">
                            <i data-feather="user"></i> <span class="text-xs mt-1">Муж.</span>
                        </button>
                        <button class="gender-btn p-3 rounded-xl border-2 dark:text-gray-300 dark:border-gray-700 hover:border-secondary-500 transition-all flex flex-col items-center" data-type="comp" data-val="female">
                            <i data-feather="user"></i> <span class="text-xs mt-1">Жен.</span>
                        </button>
                        <button class="gender-btn p-3 rounded-xl border-2 dark:text-gray-300 dark:border-gray-700 hover:border-secondary-500 transition-all flex flex-col items-center" data-type="comp" data-val="any">
                            <i data-feather="users"></i> <span class="text-xs mt-1">Любой</span>
                        </button>
                    </div>
                    <select id="compAge" class="w-full p-3 rounded-xl border-2 dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none focus:border-secondary-500">
                        <option value="" disabled selected>Возраст собеседника</option>
                        <option value="under14">До 14</option>
                        <option value="15-17">15 - 17</option>
                        <option value="18plus">18+</option>
                    </select>
                </div>
            </div>

            <div class="mt-8 flex justify-center gap-4">
                <button onclick="setTheme('light')" class="p-4 rounded-full border-2 hover:bg-white transition-all"><i data-feather="sun" class="text-yellow-500"></i></button>
                <button onclick="setTheme('dark')" class="p-4 rounded-full border-2 hover:bg-gray-800 transition-all"><i data-feather="moon" class="text-purple-400"></i></button>
            </div>

            <button id="startChatBtn" class="w-full max-w-xs mx-auto block mt-8 bg-gradient-to-r from-primary-500 to-secondary-500 text-white font-bold py-4 rounded-full shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transform active:scale-95 transition-all">
                Начать общение
            </button>
        </div>

        <div id="waitingScreen" class="hidden absolute inset-0 z-20 flex flex-col items-center justify-center bg-white dark:bg-gray-900 p-6 text-center">
            <div class="w-16 h-16 border-4 border-primary-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <h2 class="text-2xl font-bold dark:text-white">Ищем собеседника...</h2>
            <button id="cancelSearchBtn" class="mt-6 text-gray-500 underline">Отмена</button>
        </div>

        <div id="chatInterface" class="hidden h-full flex flex-col">
            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 dark:bg-gray-800/50">
                </div>
            
            <div class="p-4 bg-white dark:bg-gray-900 border-t dark:border-gray-800">
                <div id="typingIndicator" class="text-xs text-gray-400 mb-1 h-4 px-2"></div>
                <div class="flex gap-2">
                    <input type="text" id="messageInput" placeholder="Ваше сообщение..." class="flex-1 p-3 rounded-full border dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none focus:ring-2 focus:ring-primary-500">
                    <button id="sendMessageBtn" class="bg-primary-500 text-white p-3 rounded-full hover:bg-primary-600 transition-all">
                        <i data-feather="send"></i>
                    </button>
                    <button id="leaveBtn" class="bg-gray-200 dark:bg-gray-700 p-3 rounded-full hover:bg-red-500 hover:text-white transition-all">
                        <i data-feather="log-out"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    feather.replace();
    
    let connection = null;
    let userData = { gender: null, age: null, compGender: null, compAge: null };

    // Инициализация Telegram
    if (window.Telegram?.WebApp) {
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();
    }

    // Выбор пола
    document.querySelectorAll('.gender-btn').forEach(btn => {
        btn.onclick = (e) => {
            const type = btn.dataset.type;
            document.querySelectorAll(`.gender-btn[data-type="${type}"]`).forEach(b => b.classList.remove('selected', 'bg-primary-100', 'dark:bg-primary-900/30'));
            btn.classList.add('selected', 'bg-primary-100', 'dark:bg-primary-900/30');
            if(type === 'user') userData.gender = btn.dataset.val;
            else userData.compGender = btn.dataset.val;
            checkForm();
        };
    });

    // Изменение возраста
    document.getElementById('userAge').onchange = (e) => { userData.age = e.target.value; checkForm(); };
    document.getElementById('compAge').onchange = (e) => { userData.compAge = e.target.value; checkForm(); };

    function checkForm() {
        document.getElementById('startChatBtn').disabled = !(userData.gender && userData.age && userData.compGender && userData.compAge);
    }

    function setTheme(mode) {
        document.documentElement.classList.toggle('dark', mode === 'dark');
    }

    // SignalR логика
    async function startConnection() {
        const url = `${window.location.protocol}//${window.location.host}/chat`;
        connection = new signalR.HubConnectionBuilder()
            .withUrl(url)
            .withAutomaticReconnect()
            .build();

        connection.on("ReceiveMessage", (msg) => addMessage(msg.text, false));
        connection.on("MatchFound", (companion) => {
            document.getElementById('waitingScreen').classList.add('hidden');
            document.getElementById('chatInterface').classList.remove('hidden');
            addSystemMessage("Собеседник найден! Поприветствуйте его.");
        });
        connection.on("UserLeft", () => {
            addSystemMessage("Собеседник покинул чат.");
            setTimeout(() => location.reload(), 2000);
        });
        
        connection.on("TypingStatus", (isTyping) => {
            document.getElementById('typingIndicator').textContent = isTyping ? "Собеседник печатает..." : "";
        });

        try {
            await connection.start();
            document.getElementById('statusText').textContent = "Онлайн";
            document.getElementById('statusText').className = "text-green-400";
        } catch (err) {
            document.getElementById('statusText').textContent = "Ошибка связи";
            console.error(err);
        }
    }

    document.getElementById('startChatBtn').onclick = () => {
        document.getElementById('setupForm').classList.add('hidden');
        document.getElementById('waitingScreen').classList.remove('hidden');
        connection.invoke("JoinChat", {
            Gender: userData.gender,
            Age: userData.age,
            CompanionGender: userData.compGender,
            CompanionAge: userData.compAge
        });
    };

    function addMessage(text, isOwn) {
        const cont = document.getElementById('messagesContainer');
        const div = document.createElement('div');
        div.className = `flex ${isOwn ? 'justify-end' : 'justify-start'} chat-message`;
        div.innerHTML = `
            <div class="max-w-[80%] p-3 rounded-2xl ${isOwn ? 'bg-primary-500 text-white rounded-tr-none' : 'bg-white dark:bg-gray-700 dark:text-white rounded-tl-none'} shadow-sm">
                ${text}
            </div>
        `;
        cont.appendChild(div);
        cont.scrollTo({ top: cont.scrollHeight, behavior: 'smooth' });
    }

    function addSystemMessage(text) {
        const cont = document.getElementById('messagesContainer');
        const div = document.createElement('div');
        div.className = "flex justify-center chat-message";
        div.innerHTML = `<div class="bg-gray-200 dark:bg-gray-800 text-gray-500 text-[10px] px-3 py-1 rounded-full uppercase tracking-widest font-bold">${text}</div>`;
        cont.appendChild(div);
    }

    document.getElementById('sendMessageBtn').onclick = () => {
        const inp = document.getElementById('messageInput');
        if(!inp.value.trim()) return;
        connection.invoke("SendMessage", inp.value);
        addMessage(inp.value, true);
        inp.value = "";
    };

    // Передача статуса печати
    let typingTimer;
    document.getElementById('messageInput').oninput = () => {
        clearTimeout(typingTimer);
        connection.invoke("Typing", true);
        typingTimer = setTimeout(() => connection.invoke("Typing", false), 2000);
    };

    document.getElementById('leaveBtn').onclick = () => location.reload();
    document.getElementById('cancelSearchBtn').onclick = () => location.reload();

    startConnection();
</script>
</body>
</html>
