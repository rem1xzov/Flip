<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flip Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <!-- SignalR JavaScript Client -->
  <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              500: '#7c3aed',
              600: '#6d28d9',
            },
            secondary: {
              500: '#ec4899',
              600: '#db2777',
            }
          },
          borderRadius: {
            'xl': '1rem',
            '2xl': '2rem',
          }
        }
      }
    }
  </script>
  <style>
    /* ОСНОВНЫЕ СТИЛИ ВИДИМОСТИ */
    #setupForm, #chatInterface, #waitingScreen {
      display: none !important;
    }

    #setupForm.show, #chatInterface.show, #waitingScreen.show {
      display: block !important;
    }

    #chatInterface.show {
      display: flex !important;
    }

    /* ДЕСКТОП */
    @media (min-width: 769px) {
      #setupForm.show, #chatInterface.show, #waitingScreen.show {
        display: block !important;
      }
      
      #chatInterface.show {
        display: flex !important;
      }
    }

    /* МОБИЛЬНЫЕ */
    @media (max-width: 768px) {
      body {
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
      }

      .max-w-4xl {
        width: 100% !important;
        height: 100vh !important;
        margin: 0 !important;
        border-radius: 0 !important;
      }

      #messagesContainer {
        height: calc(100vh - 200px) !important;
        overflow-y: auto !important;
        padding: 15px !important;
        padding-bottom: 80px !important;
      }

      .border-t.border-gray-200 {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        background: white !important;
        padding: 15px !important;
        z-index: 1000 !important;
      }

      [data-theme="dark"] .border-t.border-gray-200 {
        background: #111827 !important;
      }
    }

    /* СТИЛИ ОТ ANDROID.HTML */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }
    
    /* Dark theme overrides */
    [data-theme="dark"] body {
      background: linear-gradient(135deg, #0f172a 0%, #111827 100%);
      color: #e5e7eb;
    }
    [data-theme="dark"] .glass-effect {
      background: rgba(17, 24, 39, 0.85);
      border-color: rgba(255,255,255,0.08);
    }
    [data-theme="dark"] .btn-primary {
      background: linear-gradient(135deg, #6d28d9 0%, #5b21b6 100%);
      box-shadow: 0 4px 15px rgba(109, 40, 217, 0.35);
    }
    [data-theme="dark"] input#messageInput {
      background-color: #111827;
      color: #e5e7eb;
      border-color: #374151;
    }
    [data-theme="dark"] .border-gray-200 { border-color: #374151 !important; }
    [data-theme="dark"] .text-gray-800 { color: #e5e7eb !important; }
    [data-theme="dark"] .text-gray-600 { color: #d1d5db !important; }
    [data-theme="dark"] .bg-gray-200 { background-color: #1f2937 !important; }
    [data-theme="dark"] #messagesContainer .chat-message div { background-color: #1f2937 !important; color: #e5e7eb !important; }
    [data-theme="dark"] .bg-white\/20 { background-color: rgba(255,255,255,0.12) !important; }
    [data-theme="dark"] .hover\:bg-white\/30:hover { background-color: rgba(255,255,255,0.2) !important; }
    [data-theme="dark"] .age-group.selected { background-color: #111827; }
    [data-theme="dark"] .comp-age-group.selected { background-color: #111827; }
    
    .age-group:hover .age-check {
      opacity: 1;
    }
    .age-check {
      transition: all 0.3s ease;
    }
    .theme-selector {
      transition: all 0.3s ease;
    }
    .theme-selector:hover {
      transform: scale(1.05);
    }
    .selected {
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.5);
    }
    .gender-option.selected {
      background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
      color: white;
      border-color: #7c3aed;
    }
    .comp-gender-option.selected {
      background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
      color: white;
      border-color: #ec4899;
    }
    .age-group.selected {
      border-color: #7c3aed;
      background-color: #f3f0ff;
    }
    .comp-age-group.selected {
      border-color: #ec4899;
      background-color: #fdf2f8;
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .btn-primary {
      background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
      box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(124, 58, 237, 0.5);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .chat-message {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .status-indicator {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* ОБЩИЕ МОБИЛЬНЫЕ СТИЛИ */
    @media (max-width: 768px) {
      body {
        padding: 0 !important;
        margin: 0 !important;
        height: 100vh;
        overflow: hidden;
      }

      body > div.max-w-4xl {
        width: 100% !important;
        max-width: 100% !important;
        height: 100vh !important;
        margin: 0 !important;
        border-radius: 0 !important;
        border: none !important;
      }

      #setupForm, #waitingScreen {
        padding: 20px !important;
        height: 100%;
        overflow-y: auto;
      }

      .grid.md\:grid-cols-2 {
        grid-template-columns: 1fr !important;
        gap: 20px !important;
      }

      #messagesContainer {
        height: calc(100vh - 180px) !important;
        padding: 15px !important;
        overflow-y: scroll !important;
        -webkit-overflow-scrolling: touch !important;
      }

      #messagesContainer::-webkit-scrollbar {
        width: 4px;
      }

      #messagesContainer::-webkit-scrollbar-track {
        background: transparent;
      }

      #messagesContainer::-webkit-scrollbar-thumb {
        background: #7c3aed;
        border-radius: 2px;
      }

      [data-theme="dark"] #messagesContainer::-webkit-scrollbar-thumb {
        background: #6d28d9;
      }

      button, .gender-option, .comp-gender-option {
        min-height: 44px !important;
        min-width: 44px !important;
      }

      .gender-option, .comp-gender-option {
        padding: 15px !important;
        font-size: 14px !important;
      }

      .age-group, .comp-age-group {
        padding: 15px !important;
        margin-bottom: 10px !important;
      }

      .theme-selector {
        width: 100px !important;
        height: 100px !important;
      }

      .w-28 { width: 100px !important; }
      .h-28 { height: 100px !important; }

      h1 { font-size: 2rem !important; }
      h2 { font-size: 1.25rem !important; }
      .text-lg { font-size: 1rem !important; }

      #messageInput {
        font-size: 16px !important;
        height: 50px !important;
      }

      #sendMessageBtn {
        min-width: 50px !important;
        min-height: 50px !important;
        padding: 15px !important;
      }
    }

    /* ВЕРТИКАЛЬНАЯ ОРИЕНТАЦИЯ - ИСПРАВЛЕННЫЙ ДИЗАЙН ЧАТА */
    @media (max-width: 768px) and (orientation: portrait) {
      #chatInterface .bg-gradient-to-r.from-primary-500.to-secondary-500 {
        padding: 1rem !important;
      }
      
      #chatInterface .bg-gradient-to-r.from-primary-500.to-secondary-500 .flex {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 0.5rem !important;
      }
      
      #chatInterface .bg-gradient-to-r.from-primary-500.to-secondary-500 .flex > div:first-child {
        width: 100% !important;
      }
      
      #chatInterface .bg-gradient-to-r.from-primary-500.to-secondary-500 .flex > div:last-child {
        width: 100% !important;
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
      }
      
      #chatInterface h2 {
        font-size: 1rem !important;
        margin-bottom: 0.25rem !important;
      }
      
      #companionInfo {
        font-size: 0.8rem !important;
      }
      
      #newCompanionBtn {
        font-size: 0.75rem !important;
        padding: 0.5rem 1rem !important;
        white-space: nowrap !important;
      }
      
      #leaveChatBtn {
        padding: 0.5rem !important;
        min-width: auto !important;
      }
      
      #messagesContainer {
        height: calc(100vh - 160px) !important;
      }
    }

    /* ГОРИЗОНТАЛЬНАЯ ОРИЕНТАЦИЯ */
    @media (max-width: 768px) and (orientation: landscape) {
      #messagesContainer {
        height: calc(100vh - 120px) !important;
        padding-bottom: 100px !important;
      }
      
      #chatInterface .bg-gradient-to-r.from-primary-500.to-secondary-500 .flex {
        flex-direction: row !important;
        align-items: center !important;
      }
    }

    /* ОЧЕНЬ МАЛЕНЬКИЕ ЭКРАНЫ */
    @media (max-width: 375px) {
      .gender-option, .comp-gender-option {
        padding: 12px !important;
        font-size: 12px !important;
      }

      .theme-selector {
        width: 80px !important;
        height: 80px !important;
      }
      
      #newCompanionBtn {
        font-size: 0.7rem !important;
        padding: 0.4rem 0.8rem !important;
      }
    }
  </style>
</head>
<body class="h-full flex items-center justify-center p-4">
<div class="max-w-4xl w-full glass-effect rounded-2xl shadow-2xl overflow-hidden border border-white/30">
  <div class="bg-gradient-to-r from-primary-500 to-secondary-500 p-8 text-white text-center">
    <h1 class="text-4xl font-bold">Flip Chat✨</h1>
    <p class="text-lg mt-3 opacity-90">Наслаждайтесь общением!</p>
    <div id="connectionStatus" class="mt-2 text-sm opacity-75">
      <span id="statusText">Подключение...</span>
    </div>
  </div>

  <!-- Setup Form -->
  <div id="setupForm" class="p-10">
    <div class="grid md:grid-cols-2 gap-10">
      <!-- Your Profile Section -->
      <div class="space-y-8">
        <h2 class="text-2xl font-semibold text-gray-800 border-b-2 pb-3 border-primary-500/20">Ваши настройки</h2>

        <!-- Gender Selection -->
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-3">Ваш пол</label>
          <div class="grid grid-cols-3 gap-3">
            <button class="gender-option py-4 px-4 rounded-full border-2 border-gray-200 hover:bg-gray-50 flex flex-col items-center justify-center transition-all hover:border-primary-500" data-gender="male">
              <i data-feather="user" class="w-6 h-6 mb-2"></i>
              <span>Муж.</span>
            </button>
            <button class="gender-option py-4 px-4 rounded-full border-2 border-gray-200 hover:bg-gray-50 flex flex-col items-center justify-center transition-all hover:border-primary-500" data-gender="female">
              <i data-feather="user" class="w-6 h-6 mb-2"></i>
              <span>Жен.</span>
            </button>
            <button class="gender-option py-4 px-4 rounded-full border-2 border-gray-200 hover:bg-gray-50 flex flex-col items-center justify-center transition-all hover:border-primary-500" data-gender="other">
              <i data-feather="user-plus" class="w-6 h-6 mb-2"></i>
              <span>Другой</span>
            </button>
          </div>
        </div>

        <!-- Your Age Group -->
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-3">Ваш возраст</label>
          <div class="space-y-3">
            <div class="age-group relative p-5 rounded-xl border-2 border-gray-200 hover:bg-gray-50 cursor-pointer transition-all hover:border-primary-500" data-age="under14">
              <div class="flex justify-between items-center">
                <span class="font-medium">До 14</span>
                <div class="age-check w-6 h-6 rounded-full border-2 border-gray-300 opacity-0 flex items-center justify-center">
                  <i data-feather="check" class="w-4 h-4 opacity-0"></i>
                </div>
              </div>
            </div>
            <div class="age-group relative p-5 rounded-xl border-2 border-gray-200 hover:bg-gray-50 cursor-pointer transition-all hover:border-primary-500" data-age="15-17">
              <div class="flex justify-between items-center">
                <span class="font-medium">15 - 17</span>
                <div class="age-check w-6 h-6 rounded-full border-2 border-gray-300 opacity-0 flex items-center justify-center">
                  <i data-feather="check" class="w-4 h-4 opacity-0"></i>
                </div>
              </div>
            </div>
            <div class="age-group relative p-5 rounded-xl border-2 border-gray-200 hover:bg-gray-50 cursor-pointer transition-all hover:border-primary-500" data-age="18plus">
              <div class="flex justify-between items-center">
                <span class="font-medium">18 и выше</span>
                <div class="age-check w-6 h-6 rounded-full border-2 border-gray-300 opacity-0 flex items-center justify-center">
                  <i data-feather="check" class="w-4 h-4 opacity-0"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Companion Preferences -->
      <div class="space-y-8">
        <h2 class="text-2xl font-semibold text-gray-800 border-b-2 pb-3 border-secondary-500/20">Настройки собеседника</h2>

        <!-- Companion Gender -->
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-3">Пол собеседника</label>
          <div class="grid grid-cols-3 gap-3">
            <button class="comp-gender-option py-4 px-4 rounded-full border-2 border-gray-200 hover:bg-gray-50 flex flex-col items-center justify-center transition-all hover:border-secondary-500" data-gender="male">
              <i data-feather="user" class="w-6 h-6 mb-2"></i>
              <span>Муж.</span>
            </button>
            <button class="comp-gender-option py-4 px-4 rounded-full border-2 border-gray-200 hover:bg-gray-50 flex flex-col items-center justify-center transition-all hover:border-secondary-500" data-gender="female">
              <i data-feather="user" class="w-6 h-6 mb-2"></i>
              <span>Жен.</span>
            </button>
            <button class="comp-gender-option py-4 px-4 rounded-full border-2 border-gray-200 hover:bg-gray-50 flex flex-col items-center justify-center transition-all hover:border-secondary-500" data-gender="any">
              <i data-feather="users" class="w-6 h-6 mb-2"></i>
              <span>Любой</span>
            </button>
          </div>
        </div>

        <!-- Companion Age Group -->
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-3">Возраст собеседника</label>
          <div class="space-y-3">
            <div class="comp-age-group relative p-5 rounded-xl border-2 border-gray-200 hover:bg-gray-50 cursor-pointer transition-all hover:border-secondary-500" data-age="under14">
              <div class="flex justify-between items-center">
                <span class="font-medium">До 14</span>
                <div class="age-check w-6 h-6 rounded-full border-2 border-gray-300 opacity-0 flex items-center justify-center">
                  <i data-feather="check" class="w-4 h-4 opacity-0"></i>
                </div>
              </div>
            </div>
            <div class="comp-age-group relative p-5 rounded-xl border-2 border-gray-200 hover:bg-gray-50 cursor-pointer transition-all hover:border-secondary-500" data-age="15-17">
              <div class="flex justify-between items-center">
                <span class="font-medium">15 - 17</span>
                <div class="age-check w-6 h-6 rounded-full border-2 border-gray-300 opacity-0 flex items-center justify-center">
                  <i data-feather="check" class="w-4 h-4 opacity-0"></i>
                </div>
              </div>
            </div>
            <div class="comp-age-group relative p-5 rounded-xl border-2 border-gray-200 hover:bg-gray-50 cursor-pointer transition-all hover:border-secondary-500" data-age="18plus">
              <div class="flex justify-between items-center">
                <span class="font-medium">18 и выше</span>
                <div class="age-check w-6 h-6 rounded-full border-2 border-gray-300 opacity-0 flex items-center justify-center">
                  <i data-feather="check" class="w-4 h-4 opacity-0"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Theme Selection -->
    <div class="mt-12">
      <label class="block text-sm font-medium text-gray-600 mb-6 text-center">Выберите тему настройки чата</label>
      <div class="flex justify-center space-x-8">
        <div class="theme-selector w-28 h-28 rounded-2xl bg-white border-2 border-gray-200 flex items-center justify-center cursor-pointer hover:border-primary-500" data-theme="light">
          <div class="w-20 h-20 bg-yellow-100 rounded-xl flex items-center justify-center">
            <i data-feather="sun" class="w-8 h-8 text-yellow-500"></i>
          </div>
        </div>
        <div class="theme-selector w-28 h-28 rounded-2xl bg-gray-800 border-2 border-gray-700 flex items-center justify-center cursor-pointer hover:border-secondary-500" data-theme="dark">
          <div class="w-20 h-20 bg-gray-700 rounded-xl flex items-center justify-center">
            <i data-feather="moon" class="w-8 h-8 text-purple-300"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Start Chat Button -->
    <div class="mt-16 text-center">
      <button id="startChatBtn" class="btn-primary px-10 py-4 text-white font-semibold rounded-full transition-all duration-300" disabled>
        Начинай общение! <i data-feather="arrow-right" class="ml-3 w-5 h-5 inline"></i>
      </button>
      <div id="validationError" class="mt-4 text-red-500 text-sm hidden"></div>
    </div>
  </div>

  <!-- Chat Interface (Hidden by default) -->
  <div id="chatInterface" class="hidden">
    <div class="bg-gradient-to-r from-primary-500 to-secondary-500 p-6 text-white">
      <div class="flex justify-between items-center">
        <div>
          <h2 class="text-xl font-bold">Чат с собеседником</h2>
          <p id="companionInfo" class="text-sm opacity-90"></p>
        </div>
        <div class="flex items-center gap-2">
          <button id="newCompanionBtn" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full transition-all text-sm">Новый собеседник</button>
          <button id="leaveChatBtn" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full transition-all">
            <i data-feather="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="h-96 overflow-y-auto p-6 space-y-4" id="messagesContainer">
      <!-- Messages will be added here -->
    </div>

    <div class="p-6 border-t border-gray-200">
      <div class="flex space-x-4">
        <input
                type="text"
                id="messageInput"
                placeholder="Введите сообщение..."
                class="flex-1 px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                maxlength="1000"
        >
        <button
                id="sendMessageBtn"
                class="btn-primary px-6 py-3 text-white font-semibold rounded-full transition-all duration-300"
        >
          <i data-feather="send" class="w-5 h-5"></i>
        </button>
      </div>
      <div class="mt-2 text-xs text-gray-500 text-center" id="charCounter">Максимум 1000 символов</div>
    </div>
  </div>

  <!-- Waiting Screen -->
  <div id="waitingScreen" class="hidden p-10 text-center">
    <div class="space-y-6">
      <div class="status-indicator">
        <i data-feather="search" class="w-16 h-16 text-primary-500 mx-auto"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-800">Поиск собеседника...</h2>
      <p class="text-gray-600">Мы ищем подходящего собеседника по вашим критериям</p>
      <div class="flex justify-center space-x-2">
        <div class="w-3 h-3 bg-primary-500 rounded-full animate-bounce"></div>
        <div class="w-3 h-3 bg-primary-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
        <div class="w-3 h-3 bg-primary-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
      </div>
      <button id="cancelSearchBtn" class="mt-6 px-6 py-3 border border-gray-300 text-gray-600 rounded-full hover:bg-gray-50 transition-all">
        Отменить поиск
      </button>
    </div>
  </div>
</div>

<script>
  feather.replace();

  // Переменные для хранения данных и подключения
  let userData = {
    gender: null,
    age: null,
    companionGender: null,
    companionAge: null,
    theme: 'light'
  };

  let connection = null;
  let isConnected = false;
  let isInChat = false;
  let isJoiningChat = false;

  // DOM элементы
  const setupForm = document.getElementById('setupForm');
  const chatInterface = document.getElementById('chatInterface');
  const waitingScreen = document.getElementById('waitingScreen');
  const statusText = document.getElementById('statusText');
  const validationError = document.getElementById('validationError');
  const startChatBtn = document.getElementById('startChatBtn');
  const messageInput = document.getElementById('messageInput');
  const messagesContainer = document.getElementById('messagesContainer');
  const sendMessageBtn = document.getElementById('sendMessageBtn');
  const companionInfoEl = document.getElementById('companionInfo');
  const charCounterEl = document.getElementById('charCounter');
  const newCompanionBtn = document.getElementById('newCompanionBtn');

  document.addEventListener('DOMContentLoaded', function() {
    // Сначала скрываем все явно
    setupForm.style.display = 'none';
    chatInterface.style.display = 'none';
    waitingScreen.style.display = 'none';

    // Потом показываем нужное
    setTimeout(() => {
      if (!isInChat && !isJoiningChat) {
        showSetupForm();
      }
    }, 100);
  });

  // ФИКС: Правильная функция для получения URL хаба
  function getHubUrl() {
    // 1. Если есть глобальная настройка - используем ее
    if (window.FLIPCHAT_BACKEND_URL && typeof window.FLIPCHAT_BACKEND_URL === 'string') {
      let backendUrl = window.FLIPCHAT_BACKEND_URL.trim();
      // Удаляем завершающие слэши
      backendUrl = backendUrl.replace(/\/+$/, '');
      // Добавляем путь к хабу
      return backendUrl + '/chat';
    }

    // 2. Для локального режима - используем текущий хост
    const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
    const host = window.location.host;

    return `${protocol}//${host}/chat`;
  }

  // ФИКС: Упрощенная функция инициализации SignalR
  function initializeSignalR() {
    try {
      const hubUrl = getHubUrl();
      console.log('Подключение к SignalR хабу:', hubUrl);

      // Используем WebSocket с автоматическим переключением на LongPolling при необходимости
      connection = new signalR.HubConnectionBuilder()
              .withUrl(hubUrl)
              .withAutomaticReconnect([0, 1000, 3000, 5000])
              .build();

      // Обработчики событий подключения
      connection.onclose((error) => {
        isConnected = false;
        updateConnectionStatus('Отключено', 'text-red-400');
        console.log('SignalR соединение закрыто:', error);
      });

      connection.onreconnecting((error) => {
        updateConnectionStatus('Переподключение...', 'text-yellow-400');
        console.log('SignalR переподключение:', error);
      });

      connection.onreconnected((connectionId) => {
        isConnected = true;
        updateConnectionStatus('Подключено', 'text-green-400');
        console.log('SignalR переподключился:', connectionId);
      });

      // Обработчики событий чата
      connection.on("ReceiveMessage", (message) => {
        addMessageToChat(message.text, false);
        // ФИКС: Автоматический скролл вниз при получении сообщения
        scrollToBottom();
      });

      connection.on("MatchFound", (companion) => {
        // ДОБАВЛЕНО: Проверяем, что мы действительно ищем собеседника
        if (!isJoiningChat) {
          console.log('Получено событие MatchFound, но isJoiningChat = false. Игнорируем.');
          return;
        }

        console.log('Найден собеседник:', companion);
        isJoiningChat = false; // Сбрасываем флаг
        showChatInterface();
        addSystemMessage('Собеседник найден! Начинайте общение!');
        if (companion && companion.gender && companion.age) {
          const genderName = companion.gender === 'male' ? 'Мужчина' : companion.gender === 'female' ? 'Женщина' : 'Другое';
          const ageName = companion.age === 'under14' ? 'До 14' : companion.age === '15-17' ? '15-17' : '18+';
          if (companionInfoEl) companionInfoEl.textContent = `${genderName}, ${ageName}`;
        } else if (companionInfoEl) {
          companionInfoEl.textContent = '';
        }
        // ФИКС: Скролл вниз при открытии чата
        setTimeout(scrollToBottom, 100);
      });

      connection.on("UserJoined", (message) => {
        console.log('Пользователь присоединился:', message);
        updateConnectionStatus('Подключено', 'text-green-400');
      });

      connection.on("UserLeft", (message) => {
        console.log('Пользователь вышел:', message);
        addSystemMessage(message);
        isInChat = false;
        isJoiningChat = false; // ДОБАВЛЕНО: сбрасываем флаг
        if (window._typingNode) {
          window._typingNode.remove();
          window._typingNode = null;
        }
        setTimeout(() => {
          clearChat();
          showSetupForm();
          validateForm();
          startChatBtn.disabled = false;
        }, 1500);
      });

      connection.on("WaitingForCompanion", () => {
        console.log('Ожидание собеседника...');
        showWaitingScreen();
      });

      connection.on('TypingStatus', (isTyping) => {
        if (!window._typingNode && isTyping) {
          window._typingNode = document.createElement('div');
          window._typingNode.className = 'chat-message flex justify-center';
          const inner = document.createElement('div');
          inner.className = 'text-xs text-gray-400 italic';
          inner.textContent = 'Собеседник печатает...';
          window._typingNode.appendChild(inner);
          messagesContainer.appendChild(window._typingNode);
          scrollToBottom();
          return;
        }
        if (window._typingNode && !isTyping) {
          window._typingNode.remove();
          window._typingNode = null;
        }
      });

      // Подключение
      connection.start()
              .then(() => {
                isConnected = true;
                updateConnectionStatus('Подключено', 'text-green-400');
                console.log('SignalR подключен');

                // ДОБАВЛЕНО: Гарантируем, что после подключения показывается форма настроек
                setTimeout(() => {
                  if (!isInChat && !isJoiningChat) {
                    showSetupForm();
                  }
                }, 100);
              })
              .catch(err => {
                console.error('Ошибка подключения:', err);
                updateConnectionStatus('Ошибка подключения', 'text-red-400');
                showError('Ошибка подключения к серверу. Проверьте, что backend запущен.');
              });

    } catch (error) {
      console.error('Ошибка инициализации SignalR:', error);
      showError('Ошибка инициализации SignalR: ' + error.message);
    }
  }

  // ФИКС: Простая функция для скролла вниз
  function scrollToBottom() {
    if (messagesContainer) {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
  }

  // Вспомогательные функции
  function persistUserData() {
    try { localStorage.setItem('flipchat:userData', JSON.stringify(userData)); } catch (_) {}
  }

  function loadUserData() {
    try {
      const raw = localStorage.getItem('flipchat:userData');
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (parsed && typeof parsed === 'object') {
        userData = { ...userData, ...parsed };
      }
    } catch (_) {}
  }

  function applyTheme(theme) {
    const root = document.documentElement;
    if (theme === 'dark') {
      root.setAttribute('data-theme', 'dark');
    } else {
      root.removeAttribute('data-theme');
    }
  }

  function clearChat() {
    if (messagesContainer) messagesContainer.innerHTML = '';
    if (companionInfoEl) companionInfoEl.textContent = '';
    if (window._typingNode) { window._typingNode.remove(); window._typingNode = null; }
    messageInput.value = '';
    sendMessageBtn.disabled = true;
  }

  function updateConnectionStatus(text, className) {
    statusText.textContent = text;
    statusText.className = className;
  }

  function showError(message) {
    validationError.textContent = message;
    validationError.classList.remove('hidden');
  }

  function showSetupForm() {
    // Скрываем все
    setupForm.classList.remove('hidden');
    setupForm.classList.add('show');
    chatInterface.classList.remove('show');
    chatInterface.classList.add('hidden');
    waitingScreen.classList.remove('show');
    waitingScreen.classList.add('hidden');
    
    // Альтернативный способ на всякий случай
    setupForm.style.display = 'block';
    chatInterface.style.display = 'none';
    waitingScreen.style.display = 'none';
    
    isInChat = false;
    isJoiningChat = false;
  }

  function showWaitingScreen() {
    setupForm.classList.remove('show');
    setupForm.classList.add('hidden');
    chatInterface.classList.remove('show');
    chatInterface.classList.add('hidden');
    waitingScreen.classList.remove('hidden');
    waitingScreen.classList.add('show');
    
    setupForm.style.display = 'none';
    chatInterface.style.display = 'none';
    waitingScreen.style.display = 'block';
  }

  function showChatInterface() {
    setupForm.classList.remove('show');
    setupForm.classList.add('hidden');
    chatInterface.classList.remove('hidden');
    chatInterface.classList.add('show');
    waitingScreen.classList.remove('show');
    waitingScreen.classList.add('hidden');
    
    setupForm.style.display = 'none';
    chatInterface.style.display = 'flex';
    waitingScreen.style.display = 'none';
    
    isInChat = true;
    messageInput.focus();
    setTimeout(scrollToBottom, 100);
  }

  function addMessageToChat(text, isOwn = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message flex ${isOwn ? 'justify-end' : 'justify-start'}`;

    const messageContent = document.createElement('div');
    messageContent.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${
            isOwn
                    ? 'bg-primary-500 text-white'
                    : 'bg-gray-200 text-gray-800'
    }`;

    const msg = document.createElement('div');
    msg.textContent = text;
    const ts = new Date();
    const time = `${String(ts.getHours()).padStart(2,'0')}:${String(ts.getMinutes()).padStart(2,'0')}`;
    const meta = document.createElement('div');
    meta.className = `text-[10px] mt-1 ${isOwn ? 'text-white/80' : 'text-gray-500'}`;
    meta.textContent = time;

    messageContent.appendChild(msg);
    messageContent.appendChild(meta);

    messageDiv.appendChild(messageContent);
    messagesContainer.appendChild(messageDiv);
    scrollToBottom();
  }

  function addSystemMessage(text) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chat-message flex justify-center';

    const messageContent = document.createElement('div');
    messageContent.className = 'px-4 py-2 rounded-2xl bg-yellow-100 text-yellow-800 text-sm';
    messageContent.textContent = text;

    messageDiv.appendChild(messageContent);
    messagesContainer.appendChild(messageDiv);
    scrollToBottom();
    return messageDiv;
  }

  function validateForm() {
    const isValid = userData.gender && userData.age && userData.companionGender && userData.companionAge;
    startChatBtn.disabled = !isValid;
    if (isValid) {
      validationError.classList.add('hidden');
    }
  }

  function sendMessage() {
    const message = messageInput.value.trim();
    if (!message || !isConnected || !isInChat) return;

    if (connection && connection.state === signalR.HubConnectionState.Connected) {
      connection.invoke("SendMessage", message)
              .then(() => {
                addMessageToChat(message, true);
                messageInput.value = '';
                sendMessageBtn.disabled = true;
                if (window._typingNode) {
                  window._typingNode.remove();
                  window._typingNode = null;
                }
                if (connection && connection.state === signalR.HubConnectionState.Connected) {
                  connection.invoke('Typing', false).catch(() => {});
                }
              })
              .catch(err => {
                console.error('Ошибка отправки сообщения:', err);
                showError('Ошибка отправки сообщения');
              });
    }
  }

  // Обработчики событий для выбора пола, возраста и темы
  const genderOptions = document.querySelectorAll('.gender-option');
  const compGenderOptions = document.querySelectorAll('.comp-gender-option');

  genderOptions.forEach(option => {
    option.addEventListener('click', function() {
      genderOptions.forEach(opt => {
        opt.classList.remove('selected', 'bg-primary-500', 'text-white', 'border-primary-500');
      });
      this.classList.add('selected', 'bg-primary-500', 'text-white', 'border-primary-500');
      userData.gender = this.dataset.gender;
      validateForm();
      persistUserData();
    });
  });

  compGenderOptions.forEach(option => {
    option.addEventListener('click', function() {
      compGenderOptions.forEach(opt => {
        opt.classList.remove('selected', 'bg-secondary-500', 'text-white', 'border-secondary-500');
      });
      this.classList.add('selected', 'bg-secondary-500', 'text-white', 'border-secondary-500');
      userData.companionGender = this.dataset.gender;
      validateForm();
      persistUserData();
    });
  });

  const ageGroups = document.querySelectorAll('.age-group');
  const compAgeGroups = document.querySelectorAll('.comp-age-group');

  ageGroups.forEach(group => {
    group.addEventListener('click', function() {
      ageGroups.forEach(g => {
        const chk = g.querySelector('.age-check');
        if (chk) chk.classList.remove('bg-primary-500', 'border-primary-500', 'opacity-100');
        g.classList.remove('selected', 'border-primary-500', 'bg-primary-50');
      });
      const check = this.querySelector('.age-check');
      if (check) check.classList.add('bg-primary-500', 'border-primary-500', 'opacity-100');
      this.classList.add('selected', 'border-primary-500', 'bg-primary-50');
      userData.age = this.dataset.age;
      validateForm();
      persistUserData();
    });
  });

  compAgeGroups.forEach(group => {
    group.addEventListener('click', function() {
      compAgeGroups.forEach(g => {
        const chk = g.querySelector('.age-check');
        if (chk) chk.classList.remove('bg-secondary-500', 'border-secondary-500', 'opacity-100');
        g.classList.remove('selected', 'border-secondary-500', 'bg-pink-50');
      });
      const check = this.querySelector('.age-check');
      if (check) check.classList.add('bg-secondary-500', 'border-secondary-500', 'opacity-100');
      this.classList.add('selected', 'border-secondary-500', 'bg-pink-50');
      userData.companionAge = this.dataset.age;
      validateForm();
      persistUserData();
    });
  });

  const themeSelectors = document.querySelectorAll('.theme-selector');
  themeSelectors.forEach(selector => {
    selector.addEventListener('click', function() {
      themeSelectors.forEach(s => s.classList.remove('selected'));
      this.classList.add('selected');
      userData.theme = this.dataset.theme;
      persistUserData();
      applyTheme(userData.theme);
    });
  });

  // Обработчики кнопок
  startChatBtn.addEventListener('click', function() {
    if (!isConnected) {
      showError('Нет подключения к серверу');
      return;
    }

    isJoiningChat = true; // ДОБАВЛЕНО: устанавливаем флаг поиска
    if (connection && connection.state === signalR.HubConnectionState.Connected) {
      startChatBtn.disabled = true;
      connection.invoke("JoinChat", userData)
              .then(() => {
                console.log('JoinChat успешно');
              })
              .catch(err => {
                console.error('JoinChat ошибка:', err);
                showError('Ошибка подключения к чату');
                startChatBtn.disabled = false;
                isJoiningChat = false; // ДОБАВЛЕНО: сбрасываем флаг при ошибке
              });
    }
  });

  messageInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  messageInput.addEventListener('input', function() {
    const txt = messageInput.value.trim();
    sendMessageBtn.disabled = !txt || !isConnected || !isInChat;
    if (connection && connection.state === signalR.HubConnectionState.Connected) {
      connection.invoke('Typing', txt.length > 0).catch(() => {});
    }
    if (charCounterEl) {
      const left = 1000 - (messageInput.value.length || 0);
      charCounterEl.textContent = `Осталось символов: ${left}`;
    }
  });

  sendMessageBtn.addEventListener('click', sendMessage);

  if (newCompanionBtn) {
    newCompanionBtn.addEventListener('click', function() {
      isJoiningChat = true; // ДОБАВЛЕНО: устанавливаем флаг поиска
      if (connection && connection.state === signalR.HubConnectionState.Connected) {
        connection.invoke('FindNewCompanion').catch(err => console.error(err));
      }
      showWaitingScreen();
    });
  }

  document.getElementById('leaveChatBtn').addEventListener('click', function() {
    isJoiningChat = false; // ДОБАВЛЕНО: сбрасываем флаг
    if (connection && connection.state === signalR.HubConnectionState.Connected) {
      connection.stop();
    }
    showSetupForm();
    startChatBtn.disabled = false;
  });

  document.getElementById('cancelSearchBtn').addEventListener('click', function() {
    isJoiningChat = false; // ДОБАВЛЕНО: сбрасываем флаг
    if (connection && connection.state === signalR.HubConnectionState.Connected) {
      connection.stop();
    }
    showSetupForm();
    startChatBtn.disabled = false;
  });

  // Инициализация при загрузке страницы
  document.addEventListener('DOMContentLoaded', function() {
    loadUserData();

    if (userData.gender) {
      const btn = document.querySelector(`.gender-option[data-gender="${userData.gender}"]`);
      if (btn) btn.click();
    }
    if (userData.companionGender) {
      const btn = document.querySelector(`.comp-gender-option[data-gender="${userData.companionGender}"]`);
      if (btn) btn.click();
    }
    if (userData.age) {
      const el = document.querySelector(`.age-group[data-age="${userData.age}"]`);
      if (el) el.click();
    }
    if (userData.companionAge) {
      const el = document.querySelector(`.comp-age-group[data-age="${userData.companionAge}"]`);
      if (el) el.click();
    }
    if (userData.theme) {
      const el = document.querySelector(`.theme-selector[data-theme="${userData.theme}"]`);
      if (el) el.click();
    }
    applyTheme(userData.theme);

    // Инициализируем соединение
    initializeSignalR();
    sendMessageBtn.disabled = true;

    // ДОБАВЛЕНО: Гарантируем, что при загрузке показывается форма настроек
    setTimeout(() => {
      if (!isInChat && !isJoiningChat) {
        showSetupForm();
      }
    }, 50);
  });
</script>
</body>
</html>
